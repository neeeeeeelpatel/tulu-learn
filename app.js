// Vocabulary Data - Complete Tulu Language Learning Content
const VOCABULARY_DATA = {
    "Basic Greetings": [
        {"tulu": "namaskAra", "english": "Hello", "pronunciation": "na-mas-kaa-ra"},
        {"tulu": "encha ullar", "english": "How are you?", "pronunciation": "en-cha ul-lar"},
        {"tulu": "yaan usar ulle", "english": "I am fine", "pronunciation": "yaan u-saar ul-le"},
        {"tulu": "solmelu", "english": "Thank you", "pronunciation": "sol-me-lu"},
        {"tulu": "barpae", "english": "Goodbye", "pronunciation": "bar-pe"},
        {"tulu": "mast dinAND tUdu", "english": "Long time no see", "pronunciation": "mast di-nand too-du"},
        {"tulu": "irena pudar enchina", "english": "What is your name?", "pronunciation": "i-re-na pu-dar en-chi-na"},
        {"tulu": "enna pudar", "english": "My name is", "pronunciation": "en-na pu-dar"},
        {"tulu": "kuDora tikk'ga", "english": "See you again", "pronunciation": "ku-do-ra tik-ga"},
        {"tulu": "yenk gothundu", "english": "I know", "pronunciation": "yenk goth-un-du"}
    ],
    "Family & People": [
        {"tulu": "ajje", "english": "Grandmother", "pronunciation": "aj-je"},
        {"tulu": "yaan", "english": "I", "pronunciation": "yaan"},
        {"tulu": "eer", "english": "You (respectful)", "pronunciation": "ee-r"},
        {"tulu": "ee", "english": "You (informal)", "pronunciation": "ee"},
        {"tulu": "aaye", "english": "He", "pronunciation": "aa-ye"},
        {"tulu": "aal", "english": "She", "pronunciation": "aal"},
        {"tulu": "aar", "english": "He/She (to elders)", "pronunciation": "aar"},
        {"tulu": "nama", "english": "We (inclusive)", "pronunciation": "na-ma"},
        {"tulu": "yenkuḷu", "english": "We (exclusive)", "pronunciation": "yen-ku-lu"},
        {"tulu": "akl", "english": "They", "pronunciation": "ak-l"}
    ],
    "Numbers & Counting": [
        {"tulu": "onji", "english": "One", "pronunciation": "on-ji"},
        {"tulu": "raDD", "english": "Two", "pronunciation": "radd"},
        {"tulu": "mooji", "english": "Three", "pronunciation": "moo-ji"},
        {"tulu": "naal", "english": "Four", "pronunciation": "naal"},
        {"tulu": "ain", "english": "Five", "pronunciation": "a-in"},
        {"tulu": "aaji", "english": "Six", "pronunciation": "aa-ji"},
        {"tulu": "El", "english": "Seven", "pronunciation": "el"},
        {"tulu": "enma", "english": "Eight", "pronunciation": "en-ma"},
        {"tulu": "ormba", "english": "Nine", "pronunciation": "orm-ba"},
        {"tulu": "patt", "english": "Ten", "pronunciation": "patt"}
    ],
    "Colors": [
        {"tulu": "kappu", "english": "Black", "pronunciation": "kap-pu"},
        {"tulu": "boldu", "english": "White", "pronunciation": "bol-du"},
        {"tulu": "kempu", "english": "Red", "pronunciation": "kem-pu"},
        {"tulu": "neeli", "english": "Blue", "pronunciation": "nee-li"},
        {"tulu": "pachhe", "english": "Green", "pronunciation": "pach-he"},
        {"tulu": "nerale", "english": "Purple", "pronunciation": "ne-ra-le"},
        {"tulu": "kandu", "english": "Brown", "pronunciation": "kan-du"},
        {"tulu": "gulabi", "english": "Pink", "pronunciation": "gu-la-bi"},
        {"tulu": "manjal", "english": "Yellow", "pronunciation": "man-jal"},
        {"tulu": "kittale", "english": "Orange", "pronunciation": "kit-ta-le"}
    ],
    "Fruits": [
        {"tulu": "bare parndh", "english": "Banana", "pronunciation": "ba-re parndh"},
        {"tulu": "kukku", "english": "Mango", "pronunciation": "kuk-ku"},
        {"tulu": "parangi pelakaayi", "english": "Pineapple", "pronunciation": "pa-ran-gi pe-la-kaa-yi"},
        {"tulu": "daalimbe", "english": "Pomegranate", "pronunciation": "daa-lim-be"},
        {"tulu": "dhrakshe", "english": "Grapes", "pronunciation": "dhrak-she"},
        {"tulu": "pela kai", "english": "Jackfruit", "pronunciation": "pe-la kai"},
        {"tulu": "peraye", "english": "Guava", "pronunciation": "pe-ra-ye"},
        {"tulu": "bacchangaayi", "english": "Watermelon", "pronunciation": "bach-chan-gaa-yi"},
        {"tulu": "chikku", "english": "Chikoo", "pronunciation": "chik-ku"},
        {"tulu": "kark parnd", "english": "Apple", "pronunciation": "kark parnd"}
    ],
    "Vegetables": [
        {"tulu": "gulla", "english": "Brinjal", "pronunciation": "gul-la"},
        {"tulu": "batate", "english": "Potato", "pronunciation": "ba-ta-te"},
        {"tulu": "tometo", "english": "Tomato", "pronunciation": "to-me-to"},
        {"tulu": "mulengi", "english": "Radish", "pronunciation": "mu-len-gi"},
        {"tulu": "neerulli", "english": "Onion", "pronunciation": "nee-rul-li"},
        {"tulu": "belluli", "english": "Garlic", "pronunciation": "bel-lu-li"},
        {"tulu": "batani", "english": "Green Peas", "pronunciation": "ba-ta-ni"},
        {"tulu": "kanchala", "english": "Bitter Gourd", "pronunciation": "kan-cha-la"},
        {"tulu": "karkambuda", "english": "Ash Gourd", "pronunciation": "kar-kam-bu-da"},
        {"tulu": "kumbuda", "english": "Pumpkin", "pronunciation": "kum-bu-da"}
    ],
    "Animals": [
        {"tulu": "naayi", "english": "Dog", "pronunciation": "naa-yi"},
        {"tulu": "putche", "english": "Cat", "pronunciation": "put-che"},
        {"tulu": "petta", "english": "Cow", "pronunciation": "pet-ta"},
        {"tulu": "kuri", "english": "Sheep", "pronunciation": "ku-ri"},
        {"tulu": "panji", "english": "Pig", "pronunciation": "pan-ji"},
        {"tulu": "kudre", "english": "Horse", "pronunciation": "kud-re"},
        {"tulu": "ane", "english": "Elephant", "pronunciation": "a-ne"},
        {"tulu": "mange", "english": "Monkey", "pronunciation": "man-ge"},
        {"tulu": "jinke", "english": "Deer", "pronunciation": "jin-ke"},
        {"tulu": "pili", "english": "Tiger", "pronunciation": "pi-li"}
    ],
    "Body Parts": [
        {"tulu": "tarae", "english": "Head", "pronunciation": "ta-rae"},
        {"tulu": "kUjal", "english": "Hair", "pronunciation": "koo-jal"},
        {"tulu": "kaNN", "english": "Eye", "pronunciation": "kann"},
        {"tulu": "kebi", "english": "Ear", "pronunciation": "ke-bi"},
        {"tulu": "mUnku", "english": "Nose", "pronunciation": "moon-ku"},
        {"tulu": "bAyi", "english": "Mouth", "pronunciation": "baa-yi"},
        {"tulu": "kai", "english": "Hand", "pronunciation": "kai"},
        {"tulu": "kAr", "english": "Leg", "pronunciation": "kaar"},
        {"tulu": "morampu", "english": "Knee", "pronunciation": "mo-ram-pu"},
        {"tulu": "tigalae", "english": "Chest", "pronunciation": "ti-ga-lae"}
    ],
    "Daily Activities": [
        {"tulu": "malpuni", "english": "Work", "pronunciation": "mal-pu-ni"},
        {"tulu": "jeppuni", "english": "Sleep", "pronunciation": "jep-pu-ni"},
        {"tulu": "tinnuni", "english": "Eat", "pronunciation": "tin-nu-ni"},
        {"tulu": "parpini", "english": "Drink", "pronunciation": "par-pi-ni"},
        {"tulu": "saippini", "english": "Walk", "pronunciation": "sai-pi-ni"},
        {"tulu": "balipu", "english": "Run", "pronunciation": "ba-li-pu"},
        {"tulu": "pola", "english": "Go", "pronunciation": "po-la"},
        {"tulu": "bala", "english": "Come", "pronunciation": "ba-la"},
        {"tulu": "kullu", "english": "Sit", "pronunciation": "kul-lu"},
        {"tulu": "paater", "english": "Talk", "pronunciation": "paa-ter"}
    ],
    "Time Expressions": [
        {"tulu": "portu", "english": "Time", "pronunciation": "por-tu"},
        {"tulu": "tingolu", "english": "Month", "pronunciation": "tin-go-lu"},
        {"tulu": "varsha", "english": "Year", "pronunciation": "var-sha"},
        {"tulu": "ainji", "english": "Now", "pronunciation": "ain-ji"},
        {"tulu": "mUvoDu", "english": "Tomorrow", "pronunciation": "moo-vo-du"},
        {"tulu": "kāltæ", "english": "Morning", "pronunciation": "kaal-tae"},
        {"tulu": "gaNTae EtAND", "english": "What is the time now?", "pronunciation": "gan-tae et-and"},
        {"tulu": "mast samayAND", "english": "Long time", "pronunciation": "mast sa-ma-yand"},
        {"tulu": "mast dinaAND", "english": "Many days", "pronunciation": "mast di-na-and"},
        {"tulu": "Epa", "english": "When", "pronunciation": "e-pa"}
    ],
    "Food & Drinks": [
        {"tulu": "vaNas", "english": "Lunch/Dinner", "pronunciation": "va-nas"},
        {"tulu": "neer", "english": "Water", "pronunciation": "neer"},
        {"tulu": "chaaya", "english": "Tea", "pronunciation": "chaa-ya"},
        {"tulu": "nAshTa", "english": "Breakfast", "pronunciation": "naash-ta"},
        {"tulu": "Kojappu", "english": "Yogurt", "pronunciation": "ko-jap-pu"},
        {"tulu": "kori", "english": "Chicken", "pronunciation": "ko-ri"},
        {"tulu": "meen", "english": "Fish", "pronunciation": "meen"},
        {"tulu": "ari", "english": "Rice (Raw)", "pronunciation": "a-ri"},
        {"tulu": "bella", "english": "Jaggery", "pronunciation": "bel-la"},
        {"tulu": "thaarayi", "english": "Coconut", "pronunciation": "thaa-ra-yi"}
    ],
    "Places": [
        {"tulu": "ill", "english": "Home", "pronunciation": "ill"},
        {"tulu": "oor", "english": "Place", "pronunciation": "oor"},
        {"tulu": "kudla", "english": "Mangalore", "pronunciation": "kud-la"},
        {"tulu": "neerullida paDpa", "english": "Near the water", "pronunciation": "nee-rul-li-da pad-pa"},
        {"tulu": "kotya", "english": "Bathroom", "pronunciation": "kot-ya"},
        {"tulu": "kuDlaD", "english": "In Mangalore", "pronunciation": "kud-lad"},
        {"tulu": "enna ill", "english": "My home", "pronunciation": "en-na ill"},
        {"tulu": "ulai", "english": "Inside", "pronunciation": "u-lai"},
        {"tulu": "pira", "english": "Outside", "pronunciation": "pi-ra"},
        {"tulu": "olu", "english": "Where", "pronunciation": "o-lu"}
    ],
    "Cultural Terms": [
        {"tulu": "bhuta kola", "english": "Spirit worship", "pronunciation": "bhoo-ta ko-la"},
        {"tulu": "yakshagana", "english": "Folk theater", "pronunciation": "yak-sha-ga-na"},
        {"tulu": "tulunadu", "english": "Tulu region", "pronunciation": "tu-lu-na-du"},
        {"tulu": "paddana", "english": "Oral epic", "pronunciation": "pad-da-na"},
        {"tulu": "bootha", "english": "Spirit deity", "pronunciation": "boo-tha"},
        {"tulu": "tigalari", "english": "Traditional script", "pronunciation": "ti-ga-la-ri"},
        {"tulu": "buDa katta", "english": "Ancestry/heritage", "pronunciation": "bu-da kat-ta"},
        {"tulu": "krI", "english": "Game", "pronunciation": "kree"},
        {"tulu": "bale tulu kalpuga", "english": "Let's learn Tulu", "pronunciation": "ba-le tu-lu kal-pu-ga"},
        {"tulu": "pAtero", "english": "Language", "pronunciation": "paa-te-ro"}
    ]
};

// Category icons for display
const CATEGORY_ICONS = {
    "Basic Greetings": "👋",
    "Family & People": "👨‍👩‍👧‍👦",
    "Numbers & Counting": "🔢",
    "Colors": "🎨",
    "Fruits": "🍎",
    "Vegetables": "🥕",
    "Animals": "🐕",
    "Body Parts": "👤",
    "Daily Activities": "⚡",
    "Time Expressions": "⏰",
    "Food & Drinks": "🍽️",
    "Places": "🏠",
    "Cultural Terms": "🎭"
};

// Application State
const AppState = {
    currentSection: 'home',
    currentLesson: null,
    currentQuestionIndex: 0,
    selectedAnswer: null,
    lessonQuestions: [],
    wrongAnswers: [],
    sessionStats: {
        totalQuestions: 0,
        correctAnswers: 0,
        wrongQuestionIds: []
    },
    userProgress: {
        xp: 0,
        streak: 0,
        level: 'Beginner',
        lessonsCompleted: [],
        wordsLearned: 0,
        totalWordsLearned: 0,
        dailyXP: 0,
        dailyGoal: 50,
        lastStudyDate: null,
        incorrectWords: []
    },
    isAnswerChecked: false,
    isReviewMode: false
};

// Question types
const QUESTION_TYPES = {
    TULU_TO_ENGLISH: 'tulu_to_english',
    ENGLISH_TO_TULU: 'english_to_tulu',
    PRONUNCIATION: 'pronunciation'
};

// Initialize Application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    loadUserProgress();
    initializeEventListeners();
    updateUI();
    showSection('home');
    generateLessonCards();
    updateDailyProgress();
}

// Event Listeners
function initializeEventListeners() {
    // Navigation
    document.querySelectorAll('.nav__btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const section = this.dataset.section;
            showSection(section);
        });
    });

    // Home screen continue learning button
    const continueLearningBtn = document.getElementById('continue-learning');
    if (continueLearningBtn) {
        continueLearningBtn.addEventListener('click', function() {
            showSection('lessons');
        });
    }

    // Practice buttons
    const practiceMistakesBtn = document.getElementById('practice-mistakes');
    const practiceRandomBtn = document.getElementById('practice-random');
    
    if (practiceMistakesBtn) {
        practiceMistakesBtn.addEventListener('click', startPracticeMistakes);
    }
    if (practiceRandomBtn) {
        practiceRandomBtn.addEventListener('click', startRandomPractice);
    }

    // Lesson interface buttons
    const checkAnswerBtn = document.getElementById('check-answer');
    const nextQuestionBtn = document.getElementById('next-question');
    const continueBtn = document.getElementById('continue-lesson');
    const exitBtn = document.getElementById('exit-lesson');
    const continueToLessonsBtn = document.getElementById('continue-to-lessons');
    const reviewLessonBtn = document.getElementById('review-lesson');
    const skipQuestionBtn = document.getElementById('skip-question');

    if (checkAnswerBtn) {
        checkAnswerBtn.addEventListener('click', checkAnswer);
    }
    if (nextQuestionBtn) {
        nextQuestionBtn.addEventListener('click', nextQuestion);
    }
    if (continueBtn) {
        continueBtn.addEventListener('click', finishLesson);
    }
    if (exitBtn) {
        exitBtn.addEventListener('click', function() {
            showSection('home');
        });
    }
    if (continueToLessonsBtn) {
        continueToLessonsBtn.addEventListener('click', function() {
            showSection('lessons');
        });
    }
    if (reviewLessonBtn) {
        reviewLessonBtn.addEventListener('click', startReviewMode);
    }
    if (skipQuestionBtn) {
        skipQuestionBtn.addEventListener('click', skipQuestion);
    }

    // Answer options event delegation
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('answer-option')) {
            selectAnswer(e.target);
        }
    });

    // Text input for pronunciation questions
    const textInput = document.getElementById('text-input');
    if (textInput) {
        textInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkAnswer();
            }
        });
    }
}

// Navigation Functions
function showSection(sectionName) {
    // Update navigation
    document.querySelectorAll('.nav__btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.section === sectionName) {
            btn.classList.add('active');
        }
    });

    // Show section
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('section--active');
    });

    const targetSection = document.getElementById(sectionName);
    if (targetSection) {
        targetSection.classList.add('section--active');
    }

    AppState.currentSection = sectionName;

    // Update section content
    if (sectionName === 'progress') {
        updateProgressSection();
    } else if (sectionName === 'lessons') {
        generateLessonCards();
    }
}

// Lesson Generation and Management
function generateLessonCards() {
    const container = document.getElementById('lesson-cards');
    if (!container) return;

    container.innerHTML = '';
    
    const categories = Object.keys(VOCABULARY_DATA);
    
    categories.forEach((category, index) => {
        const isCompleted = AppState.userProgress.lessonsCompleted.includes(category);
        const isUnlocked = index === 0 || AppState.userProgress.lessonsCompleted.includes(categories[index - 1]);
        const vocabulary = VOCABULARY_DATA[category];
        
        const card = document.createElement('div');
        card.className = 'lesson-card';
        card.dataset.lesson = category;
        
        const completedWords = isCompleted ? vocabulary.length : 0;
        const progressPercent = isCompleted ? 100 : 0;
        
        card.innerHTML = `
            <div class="lesson-card__icon">${CATEGORY_ICONS[category] || '📚'}</div>
            <h4>${category}</h4>
            <p>Learn ${vocabulary.length} essential ${category.toLowerCase()} words</p>
            <div class="lesson-card__progress">
                <div class="progress-bar">
                    <div class="progress-bar__fill" style="width: ${progressPercent}%"></div>
                </div>
                <span class="progress-text">${completedWords}/${vocabulary.length} completed</span>
            </div>
            <button class="btn ${isUnlocked ? 'btn--primary' : 'btn--secondary'} lesson-card__btn" ${!isUnlocked ? 'disabled' : ''}>
                ${isCompleted ? 'Practice Again' : isUnlocked ? 'Start Lesson' : 'Locked'}
            </button>
        `;

        if (isUnlocked) {
            const btn = card.querySelector('.lesson-card__btn');
            btn.addEventListener('click', () => startLesson(category));
        }

        container.appendChild(card);
    });
}

function startLesson(categoryName) {
    AppState.currentLesson = categoryName;
    AppState.currentQuestionIndex = 0;
    AppState.isAnswerChecked = false;
    AppState.isReviewMode = false;
    AppState.wrongAnswers = [];
    AppState.sessionStats = {
        totalQuestions: 0,
        correctAnswers: 0,
        wrongQuestionIds: []
    };

    const vocabulary = VOCABULARY_DATA[categoryName];
    AppState.lessonQuestions = generateQuestions(vocabulary);
    
    showSection('lesson-interface');
    updateLessonHeader();
    displayQuestion();
}

function generateQuestions(vocabulary) {
    const questions = [];
    const questionTypes = Object.values(QUESTION_TYPES);
    
    vocabulary.forEach((word, index) => {
        // Generate multiple question types for variety
        const questionType = questionTypes[Math.floor(Math.random() * questionTypes.length)];
        
        if (questionType === QUESTION_TYPES.TULU_TO_ENGLISH) {
            questions.push({
                id: `${AppState.currentLesson}_${index}_tulu_eng`,
                type: questionType,
                question: 'What does this word mean?',
                word: word.tulu,
                pronunciation: word.pronunciation,
                correctAnswer: word.english,
                options: generateMultipleChoice(word.english, vocabulary.map(v => v.english), 4),
                wordData: word
            });
        } else if (questionType === QUESTION_TYPES.ENGLISH_TO_TULU) {
            questions.push({
                id: `${AppState.currentLesson}_${index}_eng_tulu`,
                type: questionType,
                question: 'How do you say this in Tulu?',
                word: word.english,
                pronunciation: '',
                correctAnswer: word.tulu,
                options: generateMultipleChoice(word.tulu, vocabulary.map(v => v.tulu), 4),
                wordData: word
            });
        } else if (questionType === QUESTION_TYPES.PRONUNCIATION) {
            questions.push({
                id: `${AppState.currentLesson}_${index}_pronunciation`,
                type: questionType,
                question: 'Type the pronunciation of this word:',
                word: word.tulu,
                pronunciation: '',
                correctAnswer: word.pronunciation,
                options: [],
                wordData: word
            });
        }
    });

    return shuffleArray(questions);
}

function generateMultipleChoice(correctAnswer, allAnswers, count = 4) {
    const options = [correctAnswer];
    const otherAnswers = allAnswers.filter(answer => answer !== correctAnswer);
    
    while (options.length < count && otherAnswers.length > 0) {
        const randomIndex = Math.floor(Math.random() * otherAnswers.length);
        const randomAnswer = otherAnswers.splice(randomIndex, 1)[0];
        if (!options.includes(randomAnswer)) {
            options.push(randomAnswer);
        }
    }

    return shuffleArray(options);
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Question Display and Interaction
function updateLessonHeader() {
    const lessonTitle = document.getElementById('lesson-title');
    if (lessonTitle) {
        lessonTitle.textContent = AppState.currentLesson;
    }
}

function displayQuestion() {
    const question = AppState.lessonQuestions[AppState.currentQuestionIndex];
    if (!question) {
        finishLesson();
        return;
    }

    AppState.selectedAnswer = null;
    AppState.isAnswerChecked = false;

    // Update progress
    updateQuestionProgress();

    // Update question content
    const questionText = document.getElementById('question-text');
    const wordDisplay = document.getElementById('word-display');
    const pronunciation = document.getElementById('pronunciation');

    if (questionText) questionText.textContent = question.question;
    if (wordDisplay) wordDisplay.textContent = question.word;
    if (pronunciation) {
        if (question.pronunciation) {
            pronunciation.textContent = `(${question.pronunciation})`;
            pronunciation.style.display = 'block';
        } else {
            pronunciation.style.display = 'none';
        }
    }

    // Display appropriate input type
    if (question.type === QUESTION_TYPES.PRONUNCIATION) {
        showTextInput();
    } else {
        showMultipleChoice(question.options);
    }

    // Reset buttons and feedback
    showButton('check-answer');
    showButton('skip-question');
    hideButton('next-question');
    hideButton('continue-lesson');
    hideFeedback();
}

function updateQuestionProgress() {
    const questionCounter = document.getElementById('question-counter');
    const progressFill = document.getElementById('lesson-progress-fill');
    const totalQuestions = AppState.lessonQuestions.length;
    const currentQuestion = AppState.currentQuestionIndex + 1;

    if (questionCounter) {
        questionCounter.textContent = `${currentQuestion} of ${totalQuestions}`;
    }

    if (progressFill) {
        const progress = (AppState.currentQuestionIndex / totalQuestions) * 100;
        progressFill.style.width = `${progress}%`;
    }
}

function showMultipleChoice(options) {
    const answerOptions = document.getElementById('answer-options');
    const answerInput = document.getElementById('answer-input');
    
    if (answerOptions) answerOptions.style.display = 'grid';
    if (answerInput) answerInput.style.display = 'none';
    
    if (!answerOptions) return;

    answerOptions.innerHTML = '';
    
    options.forEach(option => {
        const optionElement = document.createElement('div');
        optionElement.className = 'answer-option';
        optionElement.textContent = option;
        optionElement.dataset.answer = option;
        answerOptions.appendChild(optionElement);
    });
}

function showTextInput() {
    const answerOptions = document.getElementById('answer-options');
    const answerInput = document.getElementById('answer-input');
    const textInput = document.getElementById('text-input');
    
    if (answerOptions) answerOptions.style.display = 'none';
    if (answerInput) answerInput.style.display = 'block';
    if (textInput) {
        textInput.value = '';
        textInput.focus();
    }
}

function selectAnswer(optionElement) {
    if (AppState.isAnswerChecked) return;

    document.querySelectorAll('.answer-option').forEach(option => {
        option.classList.remove('selected');
    });

    optionElement.classList.add('selected');
    AppState.selectedAnswer = optionElement.dataset.answer;
}

function checkAnswer() {
    if (AppState.isAnswerChecked) return;

    const question = AppState.lessonQuestions[AppState.currentQuestionIndex];
    let userAnswer = AppState.selectedAnswer;

    // For text input questions
    if (question.type === QUESTION_TYPES.PRONUNCIATION) {
        const textInput = document.getElementById('text-input');
        if (textInput) {
            userAnswer = textInput.value.trim().toLowerCase();
        }
    }

    if (!userAnswer) return;

    const correctAnswer = question.correctAnswer.toLowerCase();
    const isCorrect = userAnswer.toLowerCase() === correctAnswer;
    
    AppState.isAnswerChecked = true;
    AppState.sessionStats.totalQuestions++;

    if (isCorrect) {
        AppState.sessionStats.correctAnswers++;
        AppState.userProgress.xp += 10;
        AppState.userProgress.dailyXP += 10;
        AppState.userProgress.wordsLearned++;
    } else {
        AppState.wrongAnswers.push(question);
        AppState.sessionStats.wrongQuestionIds.push(question.id);
        
        // Add to incorrect words for future practice
        if (!AppState.userProgress.incorrectWords.find(w => w.tulu === question.wordData.tulu)) {
            AppState.userProgress.incorrectWords.push(question.wordData);
        }
    }

    // Update answer appearance
    updateAnswerAppearance(isCorrect, question.correctAnswer);
    showFeedback(isCorrect, question.correctAnswer);
    updateUI();

    // Show appropriate next button
    hideButton('check-answer');
    
    if (AppState.currentQuestionIndex < AppState.lessonQuestions.length - 1) {
        showButton('next-question');
    } else {
        showButton('continue-lesson');
    }

    // Save progress
    saveUserProgress();
}

function updateAnswerAppearance(isCorrect, correctAnswer) {
    document.querySelectorAll('.answer-option').forEach(option => {
        const answer = option.dataset.answer;
        if (answer === correctAnswer) {
            option.classList.add('correct');
        } else if (answer === AppState.selectedAnswer && !isCorrect) {
            option.classList.add('incorrect');
        }
    });
}

function nextQuestion() {
    AppState.currentQuestionIndex++;
    displayQuestion();
}

function finishLesson() {
    const accuracy = (AppState.sessionStats.correctAnswers / AppState.sessionStats.totalQuestions) * 100;
    
    calculateLessonResults();
    showCompletionScreen();
}

function calculateLessonResults() {
    const accuracy = AppState.sessionStats.totalQuestions > 0 
        ? Math.round((AppState.sessionStats.correctAnswers / AppState.sessionStats.totalQuestions) * 100)
        : 0;
    
    // Award bonus XP for high accuracy
    let bonusXP = 0;
    if (accuracy === 100) bonusXP = 50;
    else if (accuracy >= 90) bonusXP = 30;
    else if (accuracy >= 80) bonusXP = 20;
    
    AppState.userProgress.xp += bonusXP;
    AppState.userProgress.dailyXP += bonusXP;
    
    // Mark lesson as completed
    if (!AppState.userProgress.lessonsCompleted.includes(AppState.currentLesson)) {
        AppState.userProgress.lessonsCompleted.push(AppState.currentLesson);
    }
    
    // Update total words learned
    AppState.userProgress.totalWordsLearned = Math.max(
        AppState.userProgress.totalWordsLearned,
        AppState.userProgress.wordsLearned
    );

    updateUserLevel();
    saveUserProgress();
}

function showReviewOption() {
    updateCompletionScreen();
    showSection('lesson-complete');
    
    const reviewBtn = document.getElementById('review-lesson');
    if (reviewBtn) {
        reviewBtn.style.display = 'inline-flex';
    }
}

function showCompletionScreen() {
    updateCompletionScreen();
    showSection('lesson-complete');
    
    const reviewBtn = document.getElementById('review-lesson');
    if (reviewBtn) {
        reviewBtn.style.display = 'none';
    }
}

function updateCompletionScreen() {
    const xpEarned = AppState.sessionStats.correctAnswers * 10 + (AppState.userProgress.xp - (AppState.sessionStats.correctAnswers * 10));
    const accuracy = AppState.sessionStats.totalQuestions > 0 
        ? Math.round((AppState.sessionStats.correctAnswers / AppState.sessionStats.totalQuestions) * 100)
        : 0;
    
    const xpEarnedElement = document.getElementById('xp-earned');
    const accuracyElement = document.getElementById('accuracy');
    const wordsLearnedElement = document.getElementById('words-learned-session');

    if (xpEarnedElement) xpEarnedElement.textContent = xpEarned;
    if (accuracyElement) accuracyElement.textContent = `${accuracy}%`;
    if (wordsLearnedElement) wordsLearnedElement.textContent = AppState.sessionStats.correctAnswers;
}

function startReviewMode() {
    if (AppState.wrongAnswers.length === 0) return;
    
    AppState.isReviewMode = true;
    AppState.currentQuestionIndex = 0;
    AppState.lessonQuestions = [...AppState.wrongAnswers];
    AppState.wrongAnswers = [];
    AppState.sessionStats = {
        totalQuestions: 0,
        correctAnswers: 0,
        wrongQuestionIds: []
    };

    showSection('lesson-interface');
    displayQuestion();
}

// Practice Mode Functions
function startPracticeMistakes() {
    if (AppState.userProgress.incorrectWords.length === 0) {
        alert('No mistakes to practice! Complete some lessons first.');
        return;
    }
    
    AppState.currentLesson = 'Practice: Review Mistakes';
    AppState.currentQuestionIndex = 0;
    AppState.isAnswerChecked = false;
    AppState.isReviewMode = false;
    AppState.wrongAnswers = [];
    AppState.sessionStats = {
        totalQuestions: 0,
        correctAnswers: 0,
        wrongQuestionIds: []
    };

    AppState.lessonQuestions = generateQuestions(AppState.userProgress.incorrectWords.slice(0, 10));
    
    showSection('lesson-interface');
    updateLessonHeader();
    displayQuestion();
}

function startRandomPractice() {
    const allWords = [];
    Object.values(VOCABULARY_DATA).forEach(category => {
        allWords.push(...category);
    });
    
    if (allWords.length === 0) return;
    
    const randomWords = shuffleArray(allWords).slice(0, 10);
    
    AppState.currentLesson = 'Practice: Random Words';
    AppState.currentQuestionIndex = 0;
    AppState.isAnswerChecked = false;
    AppState.isReviewMode = false;
    AppState.wrongAnswers = [];
    AppState.sessionStats = {
        totalQuestions: 0,
        correctAnswers: 0,
        wrongQuestionIds: []
    };

    AppState.lessonQuestions = generateQuestions(randomWords);
    
    showSection('lesson-interface');
    updateLessonHeader();
    displayQuestion();
}

// UI Update Functions
function updateUI() {
    updateHeaderStats();
    updateDailyProgress();
    generateLessonCards();
}

function updateHeaderStats() {
    const xpDisplay = document.getElementById('xp-display');
    const streakDisplay = document.getElementById('streak-display');
    const levelDisplay = document.getElementById('level-display');

    if (xpDisplay) xpDisplay.textContent = AppState.userProgress.xp;
    if (streakDisplay) streakDisplay.textContent = AppState.userProgress.streak;
    if (levelDisplay) levelDisplay.textContent = AppState.userProgress.level;
}

function updateDailyProgress() {
    const dailyProgressFill = document.getElementById('daily-progress-fill');
    const goalText = document.querySelector('.goal-text');
    
    if (dailyProgressFill) {
        const progress = Math.min((AppState.userProgress.dailyXP / AppState.userProgress.dailyGoal) * 100, 100);
        dailyProgressFill.style.width = `${progress}%`;
    }
    
    if (goalText) {
        goalText.textContent = `${AppState.userProgress.dailyXP} / ${AppState.userProgress.dailyGoal} XP`;
    }
}

function updateUserLevel() {
    const xp = AppState.userProgress.xp;
    let newLevel = 'Beginner';
    
    if (xp >= 1000) newLevel = 'Advanced';
    else if (xp >= 500) newLevel = 'Intermediate';
    else if (xp >= 100) newLevel = 'Elementary';
    
    if (newLevel !== AppState.userProgress.level) {
        AppState.userProgress.level = newLevel;
    }
}

function updateProgressSection() {
    const totalXp = document.getElementById('total-xp');
    const wordsLearned = document.getElementById('words-learned');
    const lessonsCompleted = document.getElementById('lessons-completed');
    const currentStreak = document.getElementById('current-streak');

    if (totalXp) totalXp.textContent = AppState.userProgress.xp;
    if (wordsLearned) wordsLearned.textContent = AppState.userProgress.totalWordsLearned;
    if (lessonsCompleted) lessonsCompleted.textContent = AppState.userProgress.lessonsCompleted.length;
    if (currentStreak) currentStreak.textContent = AppState.userProgress.streak;
}

// UI Helper Functions
function showButton(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
        button.style.display = 'block';
    }
}

function hideButton(buttonId) {
    const button = document.getElementById(buttonId);
    if (button) {
        button.style.display = 'none';
    }
}

function showFeedback(isCorrect, correctAnswer) {
    const feedback = document.getElementById('feedback');
    if (!feedback) return;

    feedback.className = isCorrect ? 'feedback correct' : 'feedback incorrect';
    
    const feedbackText = feedback.querySelector('.feedback__text');
    if (feedbackText) {
        if (isCorrect) {
            feedbackText.textContent = 'Excellent! That\'s correct!';
        } else {
            feedbackText.textContent = `Correct answer: ${correctAnswer}`;
        }
    }

    feedback.style.display = 'block';
}

function hideFeedback() {
    const feedback = document.getElementById('feedback');
    if (feedback) {
        feedback.style.display = 'none';
    }
}

// Progress Persistence (Note: localStorage disabled in sandbox)
function saveUserProgress() {
    try {
        // In a real application, this would save to localStorage
        // localStorage.setItem('tuluLearningProgress', JSON.stringify(AppState.userProgress));
        console.log('Progress saved (localStorage disabled in sandbox environment)');
    } catch (error) {
        console.error('Could not save progress:', error);
    }
}

function loadUserProgress() {
    try {
        // Initialize with default values for sandbox environment
        AppState.userProgress = {
            xp: 0,
            streak: 0,
            level: 'Beginner',
            lessonsCompleted: [],
            wordsLearned: 0,
            totalWordsLearned: 0,
            dailyXP: 0,
            dailyGoal: 50,
            lastStudyDate: null,
            incorrectWords: []
        };
        
        console.log('Progress loaded with default values');
    } catch (error) {
        console.error('Could not load progress:', error);
        // Initialize with defaults on error
        AppState.userProgress = {
            xp: 0,
            streak: 0,
            level: 'Beginner',
            lessonsCompleted: [],
            wordsLearned: 0,
            totalWordsLearned: 0,
            dailyXP: 0,
            dailyGoal: 50,
            lastStudyDate: null,
            incorrectWords: []
        };
    }
}

function skipQuestion() {
    if (AppState.isAnswerChecked) return;

    const question = AppState.lessonQuestions[AppState.currentQuestionIndex];
    
    // Add to wrong answers for review
    AppState.wrongAnswers.push(question);
    AppState.sessionStats.wrongQuestionIds.push(question.id);
    
    // Add to incorrect words for future practice
    if (!AppState.userProgress.incorrectWords.find(w => w.tulu === question.wordData.tulu)) {
        AppState.userProgress.incorrectWords.push(question.wordData);
    }

    // Show feedback for skipped question
    showFeedback(false, question.correctAnswer);
    
    // Update UI
    AppState.isAnswerChecked = true;
    hideButton('check-answer');
    hideButton('skip-question');
    
    if (AppState.currentQuestionIndex < AppState.lessonQuestions.length - 1) {
        showButton('next-question');
    } else {
        showButton('continue-lesson');
    }

    // Save progress
    saveUserProgress();
}